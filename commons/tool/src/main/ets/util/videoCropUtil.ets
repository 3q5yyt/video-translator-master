import { photoAccessHelper } from "@kit.MediaLibraryKit";import { dataSharePredicates } from "@kit.ArkData";import { media } from "@kit.MediaKit";import { VideoSizeData } from "../model/VideoSizeData";export class videoCropUtil {  /**   * 获取视频的时长（单位：毫秒）   * @param selectedVideoUri 视频资源的 URI   * @returns Promise<number> 返回视频时长（毫秒）   */  static async getVideoDuration(selectedVideoUri: string, context: Context): Promise<number> {    // 1. 获取 PhotoAccessHelper 实例，用于访问系统相册/媒体资源    let phAccessHelper = photoAccessHelper.getPhotoAccessHelper(context);    // 2. 构造查询条件（Predicates）    //    这里的条件是：uri 等于传入的视频 URI    let predicates: dataSharePredicates.DataSharePredicates =      new dataSharePredicates.DataSharePredicates();    predicates.equalTo('uri', selectedVideoUri);    // 3. 指定查询的字段（fetchColumns），只取关心的信息，避免无效开销    let fetchOption: photoAccessHelper.FetchOptions = {      fetchColumns: [        photoAccessHelper.PhotoKeys.WIDTH, // 视频宽度        photoAccessHelper.PhotoKeys.HEIGHT, // 视频高度        photoAccessHelper.PhotoKeys.TITLE, // 文件名        photoAccessHelper.PhotoKeys.SIZE, // 文件大小        photoAccessHelper.PhotoKeys.DURATION// 视频时长      ],      predicates: predicates    };    // 4. 根据查询条件获取媒体资源结果集    let fetchResult: photoAccessHelper.FetchResult<photoAccessHelper.PhotoAsset> =      await phAccessHelper.getAssets(fetchOption);    // 5. 取第一条（因为通过 URI 查，应该只有一个结果）    const asset: photoAccessHelper.PhotoAsset = await fetchResult.getFirstObject();    // 6. 从查询结果中取出视频时长（毫秒）    const rawDuration = asset.get(photoAccessHelper.PhotoKeys.DURATION);    // 7. 转成 Number 并返回    return Number(rawDuration);  }  // 把毫秒数格式化成 "HH:mm:ss" 格式的时间字符串  static formatDuration(milliseconds: number): string {    // 1. 先把毫秒转成总秒数（取整）    const totalSeconds = Math.floor(milliseconds / 1000);    // 2. 计算小时数（总秒数除以3600，向下取整）    const hours = Math.floor(totalSeconds / 3600);    // 3. 计算分钟数（先取余3600，得到不足一小时的秒数，再除以60）    const minutes = Math.floor((totalSeconds % 3600) / 60);    // 4. 计算秒数（对60取余）    const seconds = totalSeconds % 60;    // 5. 把 [小时, 分钟, 秒] 依次转成字符串，不足两位的前面补0    //    例如 5 变成 "05"    return [hours, minutes, seconds]      .map(v => v.toString().padStart(2, '0'))      .join(':'); // 用 ":" 拼接成 "HH:mm:ss"  }  // 把总秒数格式化成 "HH:mm:ss" 的字符串  static formatDurationSecond(totalSeconds: number): string {    // 1. 计算小时数（总秒数除以3600，取整）    const hours = Math.floor(totalSeconds / 3600);    // 2. 计算分钟数（去掉小时后，对3600取余，再除以60，取整）    const minutes = Math.floor((totalSeconds % 3600) / 60);    // 3. 计算剩余秒数（对60取余）    const seconds = totalSeconds % 60;    // 4. 把 [小时, 分钟, 秒] 转成字符串，并且不足两位时前面补 0    //    比如 5 => "05"    return [hours, minutes, seconds]      .map(v => v.toString().padStart(2, '0'))      .join(':'); // 用 ":" 连接成 "HH:mm:ss"  }  /**   * 获取视频的尺寸和时长信息   * @param avFileDescriptor 视频文件描述符   * @returns VideoSizeData 对象，包含视频宽高和总时长   */  static async getVideoData(avFileDescriptor: media.AVFileDescriptor): Promise<VideoSizeData> {    // 1. 创建一个空的 VideoSizeData 对象，用于存储视频信息    let videoSize: VideoSizeData = new VideoSizeData();    // 2. 创建 AVMetadataExtractor 实例，用于提取视频元数据    let avMetaDataExtractor: media.AVMetadataExtractor = await media.createAVMetadataExtractor();    // 3. 设置视频源文件描述符    avMetaDataExtractor.fdSrc = avFileDescriptor;    // 4. 异步获取视频元数据    let metadata = await avMetaDataExtractor.fetchMetadata();    // 5. 从元数据中读取视频宽高，并存入 VideoSizeData    videoSize.photoSize.width = parseInt(metadata.videoWidth as string);    videoSize.photoSize.height = parseInt(metadata.videoHeight as string);    // 6. 如果元数据中包含视频时长，则保存到 VideoSizeData    if (metadata.duration) {      videoSize.totalTime = parseInt(metadata.duration);    }    // 7. 释放 AVMetadataExtractor 资源    avMetaDataExtractor.release();    // 8. 返回封装好的视频信息对象    return videoSize;  }  /**   * 获取视频的旋转方向   * @param selectedVideoUri 视频资源的 URI   * @returns Promise<number> 视频旋转角度   */  static async getVideoOrientation(selectedVideoUri: string, context: Context): Promise<boolean> {    // 1. 获取 PhotoAccessHelper 实例，用于访问系统相册/媒体资源    let phAccessHelper = photoAccessHelper.getPhotoAccessHelper(context);    // 2. 构造查询条件（Predicates）    //    这里的条件是：uri 等于传入的视频 URI    let predicates: dataSharePredicates.DataSharePredicates =      new dataSharePredicates.DataSharePredicates();    predicates.equalTo('uri', selectedVideoUri);    // 3. 指定查询的字段（fetchColumns），只取关心的信息，避免无效开销    let fetchOption: photoAccessHelper.FetchOptions = {      fetchColumns: [        photoAccessHelper.PhotoKeys.ORIENTATION, // 图片文件的方向      ],      predicates: predicates    };    // 4. 根据查询条件获取媒体资源结果集    let fetchResult: photoAccessHelper.FetchResult<photoAccessHelper.PhotoAsset> =      await phAccessHelper.getAssets(fetchOption);    // 5. 取第一条（因为通过 URI 查，应该只有一个结果）    const asset: photoAccessHelper.PhotoAsset = await fetchResult.getFirstObject();    // 6. 从查询结果中取出视频旋转角度    const rawDuration = asset.get(photoAccessHelper.PhotoKeys.ORIENTATION);    if(Number(rawDuration)%180 == 90){      return true;    }    // 7. 转成 Number 并返回    return false;  }  static timeStringToSeconds(timeStr: string): number {    const parts = timeStr.split(':'); // ["hh","mm","ss"]    if (parts.length !== 3) {      return 0;    }    const hours = parseInt(parts[0], 10);    const minutes = parseInt(parts[1], 10);    const seconds = parseInt(parts[2], 10);    return hours * 3600 + minutes * 60 + seconds;  }}